% input: dirkml, filekml, north,south east, west


%-------------------------------------------------------------
proc startkml
%-------------------------------------------------------------
line <\?xml version="1.0" encoding="UTF-8"\?>
line <kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2" xmlns:kml="http://www.opengis.net/kml/2.2" xmlns:atom="http://www.w3.org/2005/Atom">

line <Document>
line    <name>$project. - $folder.</name>
line  <open>1</open>
if (maxcc) close all
%--------------------
roundval=0.01

%--------------------
if (.not.exist(doPlacemark)) doPlacemark=1
if (.not.doPlacemark) goto endstartkml
if (.not.exist(pushpin)) setexp pushpin ylw-pushpin


gray=0
green=1
yellow=2
orange=3
orangeDark=4
red=5
magentaDark=6
blue=7

color=gray

scalePlacemark=0.8  % the scale could be defined for each placemark

col=gray
setexp colNum ff888888
exec stylePushpin
exec styleStar

col=red
setexp colNum ff0000ff
exec stylePushpin
exec styleStar

col=orange
setexp colNum ff00aaff
exec stylePushpin
exec styleStar

col=orangeDark
setexp colNum ff0055b8
exec stylePushpin
exec styleStar

col=yellow
setexp colNum ff00ffff
exec stylePushpin
exec styleStar

col=green
setexp colNum ff00ff00
exec stylePushpin
exec styleStar

col=magentaDark
setexp colNum ff980098
exec stylePushpin
exec styleStar

col=blue
setexp colNum ffffff00 
exec stylePushpin
exec styleStar

$$$$ endstartkml

%line <Folder>
%line    <name>$folder.</name>
%line  <open>1</open>

end startkml

%------------------------------------------
proc endkml
%------------------------------------------

line </Document>
line </kml>
end endkml

%------------------------------------------
proc path
% input: namePath, xpath, ypath
%------------------------------------------
line <Placemark>
line <name> $namePath </name>
line <styleUrl>#msn_ylw-pushpin</styleUrl>
line <LineString>
line <tessellate>1</tessellate>
line <coordinates>
npath=size(xpath)
ipath=0
do labpath npath
ipath=ipath+1
line #(xpath_ipath).,#(ypath_ipath).,0
end labpath
line </coordinates>
line </LineString>
line </Placemark>
end path
%-------------------------------------------------------------
proc doline
%-------------------------------------------------------------
if (eqmv(var)) eof
ndesc=ndesc+1
if (var.gt.0) var=int(var/roundval+0.5)*roundval
if (var.lt.0) var=-int(-var/roundval+0.5)*roundval
setexp desc@ndesc $cvar = #var $unmes 
end doline

%-------------------------------------------------------------
proc watchMes
%-------------------------------------------------------------
line <Folder>
line         <name>Locations</name>

toplace=0

%ID          zmaxSea        zmaxShore      distZmaxSea   distInundation    simInundation    mesInundation         simRunup         mesRunup     simDistRunup     mesDistRunup         $namePlace 

np=size(ID)

ii=do(np)

outval=simMaxHeight

m=eqmv(outval).and..not.eqmv(maxHeight)
if (sum(m).gt.0) then
i=getm(m,ii)
outval_i = maxHeight_i
endif


m=eqmv(outval)
if (sum(m).gt.0) then
i=getm(m,ii)
outval_i = -1
endif

J=order(-outval)


II=0

do labWatchMes np
II=II+1
i=J_II

if (eqmv(simMaxHeight_i).and.eqmv(maxHeight_i))  goto endlabWatchMes

id=ID_i
y=lat_i
x=long_i



type=typeMes_i

% type = -1 for simulation

if (.not.eqmv(type)) goto next

if (.not.eqmv(maxHeight_i)) then
type=2
else
type=-1
endif

$$$$ next


if (.not.eqmv(simMaxHeight_i)) then
zmax0=simMaxHeight_i
zmax1=int(zmax0/roundval+0.5)*roundval
setexp name #zmax1. /
zmax=zmax1

else
zmax=MV
zmax1=MV
setexp name /
endif

if (.not.eqmv(maxHeight_i)) then
zmax0=maxHeight_i
zmax1=int(zmax0/roundval+0.5)*roundval
setexp name $name. #zmax1
endif

if (eqmv(zmax).and..not.eqmv(zmax1)) zmax=zmax1


if (eqmv(zmax)) goto endlabWatchMes
if (zmax.lt.minzmax.and.type.lt.0) goto endlabWatchMes


if (.not.showvar) then
setexp name  
endif

% set colors

if (zmax.gt.4.8) then
color=magentaDark
else if (zmax.gt.2.4) then
color=red
else if (zmax.gt.1.2) then
color=orange
else if (zmax.gt.0.6) then
color=yellow
else % if (zmax.gt.0.3) then
color=green
endif


ndesc=0

ndesc=ndesc+1
setexp desc@ndesc simMaxHeight / mesMaxHeight

ndesc=ndesc+1
setexp desc@ndesc $$namePlace@id 

ndesc=ndesc+1
setexp desc@ndesc (#y.,#x.)   

setexp cvar simMaxHeight ; var=simMaxHeight_i  ; setexp unmes [m]
exec doline

setexp cvar mesMaxHeight ; var=maxHeight_i   ; setexp unmes [m]
exec doline

if (type.gt.0) then
setexp cvar typeMes ; var=type   ; setexp unmes [-]
exec doline
endif

setexp cvar zmaxSea ; var=zmaxSea_i    ; setexp unmes [m]
exec doline
setexp cvar zmaxShore ; var=zmaxShore_i   ; setexp unmes [m]
exec doline

setexp cvar hmaxShore ; var=hmaxShore_i    ; setexp unmes [m]
exec doline

setexp cvar tarrShore ; var=(tarrShore_i)/3600; setexp unmes [h]  
exec doline
if (.not.eqmv(var).and.exist(bulDate)) then
setexp date0 $bulDate @var hour
ndesc=ndesc+1
setexp desc@ndesc ``date --date="$date0 " `
endif

setexp cvar tzmaxShore ; var=(tzmaxShore_i)/3600; setexp unmes [h]
exec doline
if (.not.eqmv(var).and.exist(bulDate)) then
setexp date0 $bulDate @var hour
ndesc=ndesc+1
setexp desc@ndesc ``date --date="$date0 " `
endif


setexp cvar mesInundation ; var=mesInundation_i    ; setexp unmes [m]
exec doline
setexp cvar simInundation ; var=simInundation_i    ; setexp unmes [m]
exec doline


setexp cvar mesRunup ; var=mesRunup_i    ; setexp unmes [m]
exec doline
setexp cvar simRunup ; var=simRunup_i    ; setexp unmes [m]
exec doline

setexp cvar mesDistRunup ; var=mesDistRunup_i    ; setexp unmes [m]
exec doline
setexp cvar simDistRunup ; var=simDistRunup_i    ; setexp unmes [m]
exec doline


width=200

setexp place $$namePlace@id
setexp file zsurf.$place..txt.png
if (.not.existF(file)) setexp file zsurf.$place..txt.gif
if (existF(file)) then
width=width+600
ndesc=ndesc+1
setexp desc@ndesc </td><td> <img src="$file."> 
endif


if (type.lt.0) then
setexp styleType $pushpin
else
setexp styleType ltblu-stars
endif

exec placemark

if (maxcc) close all

$$$$ endlabWatchMes

end labWatchMes

line </Folder>
end watchMes



%-------------------------------------------------------------
proc watchSurveyed
%-------------------------------------------------------------
line <Folder>
line <name>Surveyed points</name>
if (.not.exist(note)) goto next
if (sum(getm(.not.eqmv(note),note)).gt.0) then
line <description>
line Note
line (1) 
line (2) 
line </description>
endif
$$$$ next

toplace=0

np=size(ID)

iord=order(-maxHeight)
ii=0



proc doline
if (eqmv(var)) eof
ndesc=ndesc+1
if (var.gt.0) var=int(var*100+0.5)/100
if (var.lt.0) var=-int(-var*100+0.5)/100
setexp desc@ndesc $cvar = #var $unmes 
end doline


do labWatchSurveyed np
ii=ii+1
i=iord_ii
id=ID_i
y=lat_i
x=long_i

if (eqmv(maxHeight_i)) eof

zmax0=maxHeight_i
zmax=int(zmax0*100+0.5)/100

setexp name  $$namePlace@id  maxHeight=#zmax

if (.not.exist(note)) goto next
if (.not.eqmv(note_i)) then
setexp name $name (@(note_i).)
endif
$$$$ next

ndesc=0

if (zmax.gt.4.8) then
color=magentaDark
else if (zmax.gt.2.4) then
color=red
else if (zmax.gt.1.2) then
color=orange
else if (zmax.gt.0.6) then
color=yellow
else % if (zmax.gt.0.3) then
color=green
endif


setexp cvar initHeight ; var=initHeight_i  ; setexp unmes [m] 
exec doline

setexp cvar maxHeight ; var=maxHeight_i  ; setexp unmes [m]
exec doline

setexp cvar tinitHeight ; var=tinitHeight_i  ; setexp unmes [min] 
exec doline

setexp cvar tmaxHeight ; var=tmaxHeight_i  ; setexp unmes [min]
exec doline

exec placemark

if (maxcc) close all

$$$$ endlabWatchSurveyed

end labWatchSurveyed

line </Folder>
end watchSurveyed



%-------------------------------------------------------------
proc watchSimulated
%-------------------------------------------------------------
line <Folder>
line         <name>Simulated points</name>

toplace=0

np=size(idSim)

iord=order(-zmaxSim)
ii=0

do labWatchSimulated np
ii=ii+1
i=iord_ii
id=idSim_i
y=latSim_i
x=longSim_i


zmax0=zmaxSim_i
zmax=int(zmax0*100+0.5)/100

setexp name  $$nameSim@id  zmaxSim=#zmax
ndesc=0

if (eqmv(zmax0)) then
setexp name  $$nameSim@id
color=gray
else if (zmax.gt.4.8) then
color=magentaDark
else if (zmax.gt.2.4) then
color=red
else if (zmax.gt.1.2) then
color=orange
else if (zmax.gt.0.6) then
color=yellow
else % if (zmax.gt.0.3) then
color=green
endif


setexp styleType $pushpin
exec placemark

if (maxcc) close all

$$$$ endlabWatchSimulated

end labWatchSimulated

line </Folder>
end watchSimulated

%-------------------------------------------------------------
proc watchShore
%-------------------------------------------------------------

maxdis=maxLookRunup
maxdem=maxDemPlace

toplace=1

line
line <Folder>
line         <name>Watch shore</name>


% idPlace latPlace longPlace zPlace cellNear latNear longNear xNear yNear zNear distNear $namePlace
read ../watch.txt tab

% idPlace         tarr        zmax0         zmax        tzmax         vmax          dem   $namePlace
setexp LCNEXT M
read ../watch/statistics.txt tab
relwork LCNEXT

if (maxcc) close all

n=max(idPlace)
kk=do(n)

latShore=dim(n)
longShore=dim(n)
latPlace1=dim(n)
longPlace1=dim(n)
zmaxShore=dim(n)
dem=dim(n)
dis=dim(n,maxdis)
dem=dim(n,maxdem)
tzmaxShore=dim(n)
tarrShore=dim(n)
id=dim(n)

latShore_idPlace=latNear
longShore_idPlace=longNear
latPlace1_idPlace=latPlace
longPlace1_idPlace=longPlace
dis_idPlace=distNear
dem_idPlace=zPlace

tzmaxShore_idPlace.M=tzmax.M
tarrShore_idPlace.M=tarr.M
zmaxShore_idPlace.M=zmax.M

id_idPlace.M=1
k=getm(id.and.dis.lt.maxdis.and.dem.lt.maxdem,kk)

k=k_order(-zmaxShore_k)

idPlace=k
latShore=latShore_k
longShore=longShore_k
latPlace1=latPlace1_k
longPlace1=longPlace1_k
zmaxShore=zmaxShore_k
tzmaxShore=tzmaxShore_k
tarrShore=tarrShore_k
dis=dis_k
dem=dem_k


if (maxcc) close all


%.........................................
np=size(idPlace)
i=0

do labWatchShore np
i=i+1
id=idPlace_i
y=latShore_i
x=longShore_i
y0=latPlace1_i
x0=longPlace1_i
distPlace=int(dis_i+0.5)
demPlace=int(dem_i+0.5)

setexp name0 $$namePlace@id 


zmax=zmaxShore_i

zmax=int(zmax*100+0.5)/100

if (zmax.lt.minzmax) goto endlabWatchShore


if (eqmv(zmax)) then
color=gray
else if (zmax.gt.4.8) then
color=magentaDark
else if (zmax.gt.2.4) then
color=red
else if (zmax.gt.1.2) then
color=orange
else if (zmax.gt.0.6) then
color=yellow
else % if (zmax.gt.0.3) then
color=green
endif

tarr=int(((tarrShore_i)/60)*10+0.5)/10
tzmax=int(((tzmaxShore_i)/60)*10+0.5)/10

setexp name $$namePlace@id zmaxShore=#zmax
setexp desc1 $dir
setexp desc2 time arrival =#tarr min 
setexp desc3 time zmax =#tzmax min 
ndesc=3

setexp styleType $pushpin
exec placemark

if (maxcc) close all

$$$$ endlabWatchShore 

end labWatchShore

line </Folder>

end watchShore

%-------------------------------------------------------------
proc dokml
%-------------------------------------------------------------

line
line <GroundOverlay>
line <name>$filekml.</name>
line  <visibility>@visibility.</visibility>
line <color>ffffffff</color>

line <Icon>
line <href>$filekml.</href>
% line <viewBoundScale>0.75</viewBoundScale>
line </Icon>

line <LatLonBox>
line <north>#north.</north>
line <south>#south.</south>
line <east>#east.</east>
line <west>#west.</west>
line </LatLonBox>
line </GroundOverlay>
end dokml


%-------------------------------------------------------------
proc dokmlTimeSpan
%-------------------------------------------------------------

line
line <GroundOverlay>
line <name>$name.</name>
line  <visibility>@visibility.</visibility>
line <color>ffffffff</color>

line <gx:TimeSpan>
line   <begin>$time1.</begin>
line   <end>$time2.</end>
line  </gx:TimeSpan>


line <Icon>
line <href>$href.</href>
% line <viewBoundScale>0.75</viewBoundScale>
line </Icon>

line <LatLonBox>
line <north>#north.</north>
line <south>#south.</south>
line <east>#east.</east>
line <west>#west.</west>
line </LatLonBox>

line </GroundOverlay>
end dokmlTimeSpan

%-------------------------------------------------------------
proc stylePushpin
%-------------------------------------------------------------
setexp styleType $pushpin
line 
line   <Style id="sh_$styleType.@col.">
line   	<IconStyle>
line 	<color>$colNum.</color>
line   		<scale>#scalePlacemark.</scale>
line   	</IconStyle>
line   	<LabelStyle>
line   		<scale>#scalePlacemark.</scale>
line   	</LabelStyle>
line   </Style>

line   <Style id="sn_$styleType.@col.">
line   	<IconStyle>
line   		<color>$colNum.</color>
line   		<scale>#scalePlacemark.</scale>
line   	</IconStyle>
line   	<LabelStyle>
line   		<scale>#scalePlacemark.</scale>
line   	</LabelStyle>
line   </Style>

line   <StyleMap id="msn_$styleType.@col.">
line   	<Pair>
line   		<key>normal</key>
line   		<styleUrl>\#sn_$styleType.@col.</styleUrl>
line   	</Pair>
line   	<Pair>
line   		<key>highlight</key>
line   		<styleUrl>\#sh_$styleType.@col.</styleUrl>
line   	</Pair>
line   </StyleMap>

end stylePushpin


%-------------------------------------------------------------
proc styleStar
%-------------------------------------------------------------
setexp styleType ltblu-stars
line <StyleMap id="msn_$styleType.@col.">
line 	<Pair>
line 		<key>normal</key>
line 		<styleUrl>\#sn_$styleType.@col.</styleUrl>
line 	</Pair>
line 	<Pair>
line 		<key>highlight</key>
line 		<styleUrl>\#sh_$styleType.@col.</styleUrl>
line 	</Pair>
line </StyleMap>

line <Style id="sh_$styleType.@col.">
line 	<IconStyle>
line   	  <color>$colNum.</color>
line   		<scale>#scalePlacemark.</scale>
line 		<Icon>
line 			<href>http://maps.google.com/mapfiles/kml/paddle/ltblu-stars.png</href>
line 		</Icon>
line 		<hotSpot x="32" y="1" xunits="pixels" yunits="pixels"/>
line 	</IconStyle>
line 	<LabelStyle>
line   		<scale>#scalePlacemark.</scale>
line 	</LabelStyle>
line 	<ListStyle>
line 		<ItemIcon>
line 			<href>http://maps.google.com/mapfiles/kml/paddle/ltblu-stars-lv.png</href>
line 		</ItemIcon>
line 	</ListStyle>
line </Style>


line <Style id="sn_$styleType.@col.">
line 	<IconStyle>
line   	  <color>$colNum.</color>
line   		<scale>#scalePlacemark.</scale>
line 		<Icon>
line 			<href>http://maps.google.com/mapfiles/kml/paddle/ltblu-stars.png</href>
line 		</Icon>
line 		<hotSpot x="32" y="1" xunits="pixels" yunits="pixels"/>
line 	</IconStyle>
line 	<LabelStyle>
line   		<scale>#scalePlacemark.</scale>
line 	</LabelStyle>
line 	<ListStyle>
line 		<ItemIcon>
line 			<href>http://maps.google.com/mapfiles/kml/paddle/ltblu-stars-lv.png</href>
line 		</ItemIcon>
line 	</ListStyle>
line </Style>

end styleStar

%-------------------------------------------------------------
proc placemark
%-------------------------------------------------------------

line
line       <Placemark>
line         <name> $name.</name>
line      <description> <![CDATA[ 
j=0

line <table width=@width.><td valign=top>
do labdesc ndesc
j=j+1
line $$desc@j. <br />
end labdesc
line </td></table>

line   ]]> </description>

line 		<LookAt>
line 			<longitude>#x.</longitude>
line 			<latitude>#y.</latitude>
line 			<altitude>0</altitude>
line 			<range>20000</range>
line 			<tilt>0</tilt>
line 			<heading>-0.05183987880918447</heading>
line 			<altitudeMode>relativeToGround</altitudeMode>
line 			<gx:altitudeMode>relativeToSeaFloor</gx:altitudeMode>
line 		</LookAt>

line 		<styleUrl>\#msn_$styleType.@color.</styleUrl>
line         <Point>
line           <coordinates>
line              #x.,#y.,0
line           </coordinates>
line         </Point>

line       </Placemark>


if (toplace) then

line
line       <Placemark>
line  <visibility>0</visibility>
line         <name>$name0.</name>
line      <description> 
line <![CDATA[ 
line distPlace=#distPlace m
line demPlace=#demPlace m
line ]]> 
line </description>

line 		<LookAt>
line 			<longitude>#x0.</longitude>
line 			<latitude>#y0.</latitude>
line 			<altitude>0</altitude>
line 			<range>20000</range>
line 			<tilt>0</tilt>
line 			<heading>-0.05183987880918447</heading>
line 			<altitudeMode>relativeToGround</altitudeMode>
line 			<gx:altitudeMode>relativeToSeaFloor</gx:altitudeMode>
line 		</LookAt>



line     <Style><LineStyle><color>FF0000FF</color><width>3</width></LineStyle></Style>
line     <LineString>
line       <altitudeMode>absolute</altitudeMode>
line       <tessellate>1</tessellate>
line       <coordinates>
line              #x.,#y.,0
line              #x0.,#y0.,#demPlace
line        </coordinates>
line     </LineString>

line       </Placemark>

endif



end placemark

proc doTime
ih=int(Time/3600)
irem=mod(Time,3600)
imin=int(irem/60)
irem=mod(irem,60)
isec=irem


if (ih.lt.10) then
setexp ch 0@ih
else
setexp ch @ih
endif

if (imin.lt.10) then
setexp cmin 0@imin
else
setexp cmin @imin
endif

if (isec.lt.10) then
setexp csec 0@isec
else
setexp csec @isec
endif

setexp ctime $ch.:$cmin.:$csec
end doTime
